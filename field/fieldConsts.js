(function (global) {
    'use strict';

    function getFallbackFieldMap() {
        return [
            [200, 200, 200, 200, 200, 0, 100, 100, 100, 100, 100, 0, 200, 200, 200, 200, 200, 0, 100, 100, 100, 100, 100, 0, 200, 200, 200, 200, 200],
            [200, 200, 200, 200, 200, 0, 100, 5221, 100, 5231, 100, 0, 200, 200, 200, 200, 200, 0, 100, 5231, 100, 5221, 100, 0, 200, 200, 200, 200, 200],
            [200, 200, 5121, 200, 200, 0, 100, 100, 5101, 100, 100, 5111, 200, 200, 5121, 200, 200, 5111, 100, 100, 5101, 100, 100, 5111, 200, 200, 5121, 200, 200],
            [200, 200, 200, 200, 200, 0, 100, 5211, 100, 5200, 100, 0, 200, 200, 200, 200, 200, 0, 100, 5200, 100, 5211, 100, 0, 200, 200, 200, 200, 200],
            [200, 200, 200, 200, 200, 0, 100, 100, 100, 100, 100, 0, 200, 200, 200, 200, 200, 0, 100, 100, 100, 100, 100, 0, 200, 200, 200, 200, 200],
            [0, 0, 5111, 0, 0, 0, 0, 0, 5112, 0, 0, 0, 0, 0, 5113, 0, 0, 0, 0, 0, 5112, 0, 0, 0, 0, 0, 5111, 0, 0],
            [100, 100, 100, 100, 100, 0, 300, 300, 300, 300, 300, 0, 400, 400, 400, 400, 400, 0, 300, 300, 300, 300, 300, 0, 100, 100, 100, 100, 100],
            [100, 5221, 100, 5211, 100, 0, 300, 300, 300, 300, 300, 0, 400, 400, 400, 400, 400, 0, 300, 300, 300, 300, 300, 0, 100, 5211, 100, 5221, 100],
            [100, 100, 5101, 100, 100, 5112, 300, 300, 5122, 300, 300, 5113, 400, 400, 5123, 400, 400, 5113, 300, 300, 5122, 300, 300, 5112, 100, 100, 5101, 100, 100],
            [100, 5231, 100, 5200, 100, 0, 300, 300, 300, 300, 300, 0, 400, 400, 400, 400, 400, 0, 300, 300, 300, 300, 300, 0, 100, 5200, 100, 5231, 100],
            [100, 100, 100, 100, 100, 0, 300, 300, 300, 300, 300, 0, 400, 400, 400, 400, 400, 0, 300, 300, 300, 300, 300, 0, 100, 100, 100, 100, 100],
            [0, 0, 5111, 0, 0, 0, 0, 0, 5113, 0, 0, 0, 0, 0, 5114, 0, 0, 0, 0, 0, 5113, 0, 0, 0, 0, 0, 5111, 0, 0],
            [200, 200, 200, 200, 200, 0, 400, 400, 400, 400, 400, 0, 500, 500, 500, 500, 500, 0, 400, 400, 400, 400, 400, 0, 200, 200, 200, 200, 200],
            [200, 200, 200, 200, 200, 0, 400, 400, 400, 400, 400, 0, 500, 500, 500, 500, 500, 0, 400, 400, 400, 400, 400, 0, 200, 200, 200, 200, 200],
            [200, 200, 5121, 200, 200, 5113, 400, 400, 5123, 400, 400, 5114, 500, 500, 5131, 500, 500, 5114, 400, 400, 5123, 400, 400, 5113, 200, 200, 5121, 200, 200],
            [200, 200, 200, 200, 200, 0, 400, 400, 400, 400, 400, 0, 500, 500, 500, 500, 500, 0, 400, 400, 400, 400, 400, 0, 200, 200, 200, 200, 200],
            [200, 200, 200, 200, 200, 0, 400, 400, 400, 400, 400, 0, 500, 500, 500, 500, 500, 0, 400, 400, 400, 400, 400, 0, 200, 200, 200, 200, 200],
            [0, 0, 5111, 0, 0, 0, 0, 0, 5113, 0, 0, 0, 0, 0, 5114, 0, 0, 0, 0, 0, 5113, 0, 0, 0, 0, 0, 5111, 0, 0],
            [100, 100, 100, 100, 100, 0, 300, 300, 300, 300, 300, 0, 400, 400, 400, 400, 400, 0, 300, 300, 300, 300, 300, 0, 100, 100, 100, 100, 100],
            [100, 5231, 100, 5200, 100, 0, 300, 300, 300, 300, 300, 0, 400, 400, 400, 400, 400, 0, 300, 300, 300, 300, 300, 0, 100, 5200, 100, 5231, 100],
            [100, 100, 5101, 100, 100, 5112, 300, 300, 5122, 300, 300, 5113, 400, 400, 5123, 400, 400, 5113, 300, 300, 5122, 300, 300, 5112, 100, 100, 5101, 100, 100],
            [100, 5221, 100, 5211, 100, 0, 300, 300, 300, 300, 300, 0, 400, 400, 400, 400, 400, 0, 300, 300, 300, 300, 300, 0, 100, 5211, 100, 5221, 100],
            [100, 100, 100, 100, 100, 0, 300, 300, 300, 300, 300, 0, 400, 400, 400, 400, 400, 0, 300, 300, 300, 300, 300, 0, 100, 100, 100, 100, 100],
            [0, 0, 5111, 0, 0, 0, 0, 0, 5112, 0, 0, 0, 0, 0, 5113, 0, 0, 0, 0, 0, 5112, 0, 0, 0, 0, 0, 5111, 0, 0],
            [200, 200, 200, 200, 200, 0, 100, 100, 100, 100, 100, 0, 200, 200, 200, 200, 200, 0, 100, 100, 100, 100, 100, 0, 200, 200, 200, 200, 200],
            [200, 200, 200, 200, 200, 0, 100, 5211, 100, 5200, 100, 0, 200, 200, 200, 200, 200, 0, 100, 5200, 100, 5211, 100, 0, 200, 200, 200, 200, 200],
            [200, 200, 5121, 200, 200, 5111, 100, 100, 5101, 100, 100, 5111, 200, 200, 5100, 200, 200, 5111, 100, 100, 5101, 100, 100, 5111, 200, 200, 5121, 200, 200],
            [200, 200, 200, 200, 200, 0, 100, 5221, 100, 5231, 100, 0, 200, 200, 200, 200, 200, 0, 100, 5231, 100, 5221, 100, 0, 200, 200, 200, 200, 200],
            [200, 200, 200, 200, 200, 0, 100, 100, 100, 100, 100, 0, 200, 200, 200, 200, 200, 0, 100, 100, 100, 100, 100, 0, 200, 200, 200, 200, 200]
        ];
    }

    function buildFieldConsts(gameData, fieldEventConfig) {
        const cfg = fieldEventConfig || {};
        const FIELD_EVENT_TYPES = {
            BANDIT: 2001,
            BANDIT_LEADER: 2002,
            DUNGEON: 2010,
            PORTAL: 2020,
            CARAVAN: 2030,
            CROWN: 2040
        };
        const FIELD_EVENT_RATES = {
            [FIELD_EVENT_TYPES.BANDIT]: 15,
            [FIELD_EVENT_TYPES.BANDIT_LEADER]: 5,
            [FIELD_EVENT_TYPES.DUNGEON]: 3,
            [FIELD_EVENT_TYPES.PORTAL]: 2,
            [FIELD_EVENT_TYPES.CARAVAN]: 4,
            ...(cfg.RATES || {})
        };
        const DEFAULT_EVENT_DROP_TABLE = {
            [FIELD_EVENT_TYPES.BANDIT]: { gold: [50, 100], items: [{ code: 1801, prob: 20 }] },
            [FIELD_EVENT_TYPES.BANDIT_LEADER]: { gold: [200, 400], items: [{ code: 1811, prob: 30 }, { code: 1201, prob: 10 }] },
            [FIELD_EVENT_TYPES.DUNGEON]: { gold: [500, 1000], items: [{ code: 2101, prob: 50 }, { code: 1210, prob: 20 }] },
            [FIELD_EVENT_TYPES.CROWN]: { gold: [700, 1200], items: [{ code: 1812, prob: 35 }, { code: 1210, prob: 25 }] }
        };
        const EVENT_DROP_TABLE = Object.assign({}, DEFAULT_EVENT_DROP_TABLE, cfg.DROP_TABLE || {});
        const DEFAULT_FIELD_OBJECT_REWARD_TABLE = {
            1: [{ kind: 'gold', min: 80, max: 120 }],
            2: [{ kind: 'energy', min: 15, max: 25 }],
            3: [{ kind: 'gem', min: 1, max: 2 }],
            4: [{ kind: 'chest', level: 1, count: 1 }],
            11: [{ kind: 'gold', min: 120, max: 220 }, { kind: 'energy', min: 10, max: 20 }],
            12: [{ kind: 'item_code', code: 1801, min_count: 1, max_count: 2 }],
            13: [{ kind: 'item_code', code: 1811, min_count: 1, max_count: 2 }]
        };
        const FIELD_OBJECT_REWARD_TABLE = Object.assign(
            {},
            DEFAULT_FIELD_OBJECT_REWARD_TABLE,
            gameData?.constants?.FIELD_OBJECT_REWARDS || {}
        );

        const FIELD_MAP_DATA = getFallbackFieldMap();
        const dataFieldMap = Array.isArray(gameData?.field_map) ? gameData.field_map : null;
        if (dataFieldMap && dataFieldMap.length > 0 && dataFieldMap.every((row) => Array.isArray(row))) {
            FIELD_MAP_DATA.length = 0;
            dataFieldMap.forEach((row) => FIELD_MAP_DATA.push(row.map((cell) => Number(cell))));
        }
        const FIELD_TERRAIN_DATA = FIELD_MAP_DATA.map((row) => row.slice());
        const MAP_SIZE = FIELD_MAP_DATA.length;

        const PLAYER_START = { r: 18, c: 4 };

        const FOG_RADIUS = 8;

        return {
            FIELD_EVENT_TYPES,
            FIELD_EVENT_RATES,
            DEFAULT_EVENT_DROP_TABLE,
            EVENT_DROP_TABLE,
            DEFAULT_FIELD_OBJECT_REWARD_TABLE,
            FIELD_OBJECT_REWARD_TABLE,
            FIELD_MAP_DATA,
            FIELD_TERRAIN_DATA,
            MAP_SIZE,
            PLAYER_START,
            FOG_RADIUS
        };
    }

    global.KOVFieldConstsModule = {
        buildFieldConsts
    };
})(window);
